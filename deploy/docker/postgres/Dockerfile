# QIS Database server
#
# Runs a pre-configured instance of PostgreSQL on Ubuntu 16.04.
#
# Environment variables:
#   PG_USER - Optional - the QIS database login username
#   PG_PASSWORD - Required - the QIS database login password
#   PG_MAX_CONNECTIONS - Optional - the Postgres connection limit
#   PG_SHARED_BUFFERS - Optional - the Postgres internal cache size
#   PG_EFFECTIVE_CACHE_SIZE - Optional - the expected o/s free memory + buffers total
#
FROM ubuntu:16.04
MAINTAINER Matt Fozard <matt@quru.com>

# Base o/s + app layer
RUN apt-get update && \
    apt-get install -y postgresql-9.5 && \
    apt-get clean
RUN locale-gen en_GB.UTF-8 && update-locale LANG=en_GB.UTF-8 LC_ALL=en_GB.UTF-8

# Ports
EXPOSE 5432

# Environment variables
ENV PG_USER=qis \
    PG_PASSWORD=qispass \
    PG_MAX_CONNECTIONS=100 \
    PG_SHARED_BUFFERS=250MB \
    PG_EFFECTIVE_CACHE_SIZE=750MB

# Add files to the image
WORKDIR /var/lib/postgresql/
COPY *.sh ./
RUN chmod a+x *.sh && chown postgres:postgres *.sh

# Run initialisation scripts
USER postgres
RUN /usr/lib/postgresql/9.5/bin/initdb --locale=en_GB.UTF-8 -D /var/lib/postgresql/9.5/data

# Require passwords for external connections
RUN echo "host    all             all             0.0.0.0/0               md5" >> /var/lib/postgresql/9.5/data/pg_hba.conf

# Enable external TCP connections, set logging to stderr for Docker to pick up
RUN echo "listen_addresses = '*'" >> /var/lib/postgresql/9.5/data/postgresql.conf && \
    echo "log_destination = 'stderr'" >> /var/lib/postgresql/9.5/data/postgresql.conf

# Declare data volumes
VOLUME ["/var/lib/postgresql/9.5/data"]

# Run regular health checks
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD /var/lib/postgresql/check-postgres.sh

# Command
CMD ["/var/lib/postgresql/run-postgres.sh"]
